<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一文理解 Python 装饰器 | Ronald Zhao&#39;s Blog</title>
    <meta name="description" content="Stay hungary. Stay foolish. —— Steve Jobs">
    <link rel="icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.d05eef06.css" as="style"><link rel="preload" href="/assets/js/app.be76193c.js" as="script"><link rel="preload" href="/assets/js/40.98ee207e.js" as="script"><link rel="prefetch" href="/assets/js/22.c78c4742.js"><link rel="prefetch" href="/assets/js/2.cda51ec0.js"><link rel="prefetch" href="/assets/js/3.3c35b562.js"><link rel="prefetch" href="/assets/js/4.60f3a777.js"><link rel="prefetch" href="/assets/js/5.d6064ed8.js"><link rel="prefetch" href="/assets/js/6.cb087673.js"><link rel="prefetch" href="/assets/js/7.9e6a2783.js"><link rel="prefetch" href="/assets/js/8.4edc4fc3.js"><link rel="prefetch" href="/assets/js/9.07f46923.js"><link rel="prefetch" href="/assets/js/10.5121d4a8.js"><link rel="prefetch" href="/assets/js/11.2efd76bc.js"><link rel="prefetch" href="/assets/js/12.2d20079d.js"><link rel="prefetch" href="/assets/js/13.f5603a78.js"><link rel="prefetch" href="/assets/js/14.1ce0653e.js"><link rel="prefetch" href="/assets/js/15.e7b5fbd4.js"><link rel="prefetch" href="/assets/js/16.9c73da5f.js"><link rel="prefetch" href="/assets/js/17.52e82310.js"><link rel="prefetch" href="/assets/js/18.46f38a88.js"><link rel="prefetch" href="/assets/js/19.663a210b.js"><link rel="prefetch" href="/assets/js/20.6fc91ceb.js"><link rel="prefetch" href="/assets/js/21.b5469d1b.js"><link rel="prefetch" href="/assets/js/23.980f927d.js"><link rel="prefetch" href="/assets/js/24.8af97d98.js"><link rel="prefetch" href="/assets/js/25.c2cdcfbb.js"><link rel="prefetch" href="/assets/js/26.53c72fed.js"><link rel="prefetch" href="/assets/js/27.b9313abd.js"><link rel="prefetch" href="/assets/js/28.90a9b1cb.js"><link rel="prefetch" href="/assets/js/29.c7587609.js"><link rel="prefetch" href="/assets/js/30.78f106d7.js"><link rel="prefetch" href="/assets/js/31.e5d427f6.js"><link rel="prefetch" href="/assets/js/32.1b1d52cf.js"><link rel="prefetch" href="/assets/js/33.7fe26887.js"><link rel="prefetch" href="/assets/js/34.f33b6896.js"><link rel="prefetch" href="/assets/js/35.984e3ad2.js"><link rel="prefetch" href="/assets/js/36.f0262757.js"><link rel="prefetch" href="/assets/js/37.10f8a393.js"><link rel="prefetch" href="/assets/js/38.fbd0754f.js"><link rel="prefetch" href="/assets/js/39.a0f1e21a.js"><link rel="prefetch" href="/assets/js/41.cf9bb286.js"><link rel="prefetch" href="/assets/js/42.2615d4ca.js"><link rel="prefetch" href="/assets/js/43.4fdf63ac.js"><link rel="prefetch" href="/assets/js/44.4b6e9a9e.js"><link rel="prefetch" href="/assets/js/45.817a7ad2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d05eef06.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Ronald Zhao's Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/python3/" class="nav-link router-link-active">Python3</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">刷题</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lintcode/level-0.html" class="nav-link">LintCode</a></li><li class="dropdown-item"><!----> <a href="/leetcode/easy.html" class="nav-link">LeetCode</a></li><li class="dropdown-item"><!----> <a href="/codewars/" class="nav-link">CodeWars</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><a href="/algorithms/" class="nav-link">Algorithms</a></div><div class="nav-item"><a href="/guide/" class="nav-link">Guide</a></div><div class="nav-item"><a href="/notes/" class="nav-link">Notes</a></div><div class="nav-item"><a href="/devtools/" class="nav-link">Tools</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/love/" class="nav-link">💗</a></div> <a href="https://github.com/RonaldZhao/RonaldZhao.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/python3/" class="nav-link router-link-active">Python3</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">刷题</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/lintcode/level-0.html" class="nav-link">LintCode</a></li><li class="dropdown-item"><!----> <a href="/leetcode/easy.html" class="nav-link">LeetCode</a></li><li class="dropdown-item"><!----> <a href="/codewars/" class="nav-link">CodeWars</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><a href="/algorithms/" class="nav-link">Algorithms</a></div><div class="nav-item"><a href="/guide/" class="nav-link">Guide</a></div><div class="nav-item"><a href="/notes/" class="nav-link">Notes</a></div><div class="nav-item"><a href="/devtools/" class="nav-link">Tools</a></div><div class="nav-item"><a href="/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="/love/" class="nav-link">💗</a></div> <a href="https://github.com/RonaldZhao/RonaldZhao.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/python3/" class="sidebar-link">一文理解 Python 装饰器</a></li><li><a href="/python3/generate-random-array.html" class="sidebar-link">生成指定范围内的指定个数随机数的list</a></li><li><a href="/python3/python-electronjs.html" class="sidebar-link">使用 Python 和 ElectronJS 制作现代化的 GUI</a></li><li><a href="/python3/blzyy.html" class="sidebar-link">Python变量的作用域</a></li><li><a href="/python3/closure.html" class="sidebar-link">一文看懂Python闭包</a></li><li><a href="/python3/interview.html" class="sidebar-link">Python面试题收集整理</a></li><li><a href="/python3/multiple-inheritance-mixin.html" class="sidebar-link">一文理解Python多重继承</a></li><li><a href="/python3/traps.html" class="sidebar-link">不可不知的Python陷阱</a></li><li><a href="/python3/yield-generator.html" class="sidebar-link">yield和generator</a></li><li><a href="/python3/yield-from.html" class="sidebar-link">yield from</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="一文理解-python-装饰器"><a href="#一文理解-python-装饰器" aria-hidden="true" class="header-anchor">#</a> 一文理解 Python 装饰器</h1> <blockquote><p>原文链接: <a href="https://foofish.net/python-decorator.html" target="_blank" rel="noopener noreferrer">理解 Python 装饰器看这一篇就够了<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="python-装饰器是什么"><a href="#python-装饰器是什么" aria-hidden="true" class="header-anchor">#</a> Python 装饰器是什么?</h2> <p>举个栗子:</p> <p>我们都知道内裤的主要功能是用来遮羞, 但是到了冬天它无法防风御寒. 咋办? 一个办法就是把内裤改造得又长又厚. 但同时又有个问题, 它本质上已经不是一条内裤了, 而成了长裤. 于是聪明的做法是在内裤外面再穿一条长裤. 这样内裤便还是内裤, 而且通过套在外面的长裤达到了保暖的作用. <code>装饰器</code>就如同这里的长裤, 可以在不改变内裤的前提下增加额外的功能.</p> <p>正确理解 Python 装饰器前, 还要明白一件事: Python 中的函数和 C++, Java 中的函数不大一样. Python 中的函数可以像普通变量一样当作参数传递给另一个函数, 例如:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">param</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'this is function param()'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    p<span class="token punctuation">(</span><span class="token punctuation">)</span>

f<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Python 装饰器本质上就是一个 Python 函数或类, 它可以让其他函数或类在不改变代码的前提下增加额外的功能. Python 装饰器的返回值也是一个函数或类对象.</p> <p>Python 装饰器经常用于有切面需求的场景, 比如: 插入日志, 性能测试, 事务处理, 缓存, 权限校验等场景, Python 装饰器是解决这类问题的绝佳设计. 有了 Python 装饰器, 我们就可以抽离出大量与函数功能本身无关的雷同代码到装饰器中并继续重用. 概括地讲, Python 装饰器的作用就是在不改动现有对象的前提下为其增加功能.</p> <p>一个简单的例子:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'this is function f()'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在有一个新的需求: 希望可以记录下函数的执行日志. 于是可以这么改:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'this is function f()'</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'function f() is running.'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这是需求只涉及到一个函数的情况(很简单). 但是如果需求涉及到大量的函数, 如果再这样做的话就会造成大量的雷同代码. 于是为了减少重复书写雷同代码的愚蠢行为, 我们可以重新定义一个新的函数用来专门处理日志, 日志处理完毕之后再执行真正的业务代码:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">use_logging</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">'{0} is running.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>
    f<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'this is function f()'</span><span class="token punctuation">)</span>

use_logging<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这样逻辑上没有问题, 需求也实现了, 但是我们在调用的时候已经不再是调用真正的业务逻辑<code>f()</code>函数了, 而是换成了<code>use_logging()</code>函数, 这样就破坏了原有的代码结构, 现在我们不得不每次都要把原来的那个<code>f()</code>函数作为参数传递给<code>use_logging()</code>函数...</p> <p>于是, Python 装饰器横空出世.</p> <h2 id="简单装饰器-装饰无参函数"><a href="#简单装饰器-装饰无参函数" aria-hidden="true" class="header-anchor">#</a> 简单装饰器(装饰无参函数)</h2> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">use_logging</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">'{0} is running.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> wrapper

<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'this is function f()'</span><span class="token punctuation">)</span>

f <span class="token operator">=</span> use_logging<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
f<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里的<code>use_logging()</code>函数就是一个装饰器, 它是一个普通的函数, 它把真正执行业务逻辑的函数<code>f()</code>包裹在其中, 于是<code>f()</code>函数看起来就像被<code>use_logging()</code>装饰了一样. <code>use_logging()</code>返回的也是一个函数, 这个函数的名字叫<code>wrapper</code>.</p> <p>在这个例子中, 函数进入和退出时, 被称为一个横切面, 所以这种编程方式被称为面向切面的编程.</p> <h2 id="语法糖"><a href="#语法糖" aria-hidden="true" class="header-anchor">#</a> @语法糖</h2> <p><code>@</code>符号是 Python 装饰器的语法糖, 它放在函数开始定义(即<code>def</code>)的上方, 这样就可以省略最后一步对函数重新赋值的操作.</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">use_logging</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">'{0} is running.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> wrapper

@use_logging
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'this is function f()'</span><span class="token punctuation">)</span>

f<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如上所示, 有了<code>@</code>, 我们就可以省去<code>f = use_logging(f)</code>这一行了, 直接调用<code>f()</code>即可得到想要的结果.</p> <p>从这个例子也可以看出, <code>f()</code>函数不需要做任何的修改, 只需要在定义的地方加上装饰器, 调用方式依然不变. 如果有其他的类似函数, 我们就可以继续调用装饰器来修饰函数, 而不用重复修改函数或增加新的封装. 这样, 我们就提高了程序的可重用性, 并增加了程序的可读性.</p> <h2 id="args-kwargs"><a href="#args-kwargs" aria-hidden="true" class="header-anchor">#</a> <code>*args</code>, <code>**kwargs</code></h2> <p>对于无参数的函数, 以上装饰器已经可以达成所需了. 但是当业务逻辑函数带有参数的时候, 就要对装饰器稍加修改了. 比如:</p> <div class="language-python line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">use_logging</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">'{0} is running.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> func<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> wrapper

@use_logging
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'i am {0}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>

f<span class="token punctuation">(</span><span class="token string">'ronald'</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>但是这只能适用于参数个数固定为一个的情况, 对于多个参数甚至参数个数不固定的函数, 就要使用<code>*args</code>来代替:</p> <div class="language-python line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">use_logging</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">'{0} is running.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> wrapper

@use_logging
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'my name is {0} and i am {1} years old.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span>

f<span class="token punctuation">(</span><span class="token string">'ronald'</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>但是对于关键字参数, <code>*args</code>也是无能为力的, 所以就需要继续加上<code>**kwargs</code>了:</p> <div class="language-python line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">use_logging</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">'{0} is running.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> wrapper

@use_logging
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'my name is {0} and i am {1} years old.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">)</span>

f<span class="token punctuation">(</span><span class="token string">'ronald'</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="带参数的装饰器"><a href="#带参数的装饰器" aria-hidden="true" class="header-anchor">#</a> 带参数的装饰器</h2> <p>Python 装饰器还有更大的灵活性, 例如带参数的装饰器. 在上面的装饰器调用中, 该装饰器接收的唯一参数就是执行业务的<code>f</code>函数. 装饰器的语法允许我们在调用时提供其他参数, 比如<code>@decorator(a)</code>. 这样, 就为装饰器的编写和使用提供了更大的灵活性. 比如, 我们可以在装饰器中指定日志的等级, 因为不同的业务函数可能需要的日志等级是不一样的:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">use_logging</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> level <span class="token operator">==</span> <span class="token string">'warn'</span><span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">'{0} is running.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> level <span class="token operator">==</span> <span class="token string">'info'</span><span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'{0} is running.'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> wrapper
    <span class="token keyword">return</span> decorator

@use_logging<span class="token punctuation">(</span>level<span class="token operator">=</span><span class="token string">'warn'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'ronald'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'i am {0}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>

f<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>上面的<code>use_logging</code>是允许带参数的装饰器. 它实际上是对原装饰器的一个函数封装, 并返回一个装饰器. 我们可以将它理解为一个含有参数的闭包. 当我们使用<code>@use_logging(level='warn')</code>调用的时候, Python 能够发现这一层的封装, 并把参数传递到装饰器的环境中.</p> <h2 id="类装饰器"><a href="#类装饰器" aria-hidden="true" class="header-anchor">#</a> 类装饰器</h2> <p>Python 装饰器不仅可以是函数, 还可以是类. 相比函数装饰器, 类装饰器具有灵活度大, 高内聚, 封装性等优点. 使用类装饰器主要依靠类的<code>__call__</code>方法, 当使用<code>@</code>形式将装饰器附加到函数上时, 就会自动调用此方法:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">F</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>func <span class="token operator">=</span> func

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'class decorator is running...'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>func<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'class decorator ended.'</span><span class="token punctuation">)</span>

@F
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'function f().'</span><span class="token punctuation">)</span>

f<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div> <h2 id="装饰器顺序"><a href="#装饰器顺序" aria-hidden="true" class="header-anchor">#</a> 装饰器顺序</h2> <p>一个函数可以同时被多个装饰器修饰, 如:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>@a
@b
@c
<span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>它的执行顺序是从里到外(或者说从近到远), 即最先调用最里层的装饰器, 等效于:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>f <span class="token operator">=</span> a<span class="token punctuation">(</span>b<span class="token punctuation">(</span>c<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">2018-9-6 21:14:43</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/40.98ee207e.js" defer></script><script src="/assets/js/app.be76193c.js" defer></script>
  </body>
</html>
